<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Severe Weather Score</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 2rem;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
      }
      .score-box {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .stats-table {
        width: 100%;
        margin-bottom: 2rem;
        border-collapse: collapse;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        overflow: hidden;
      }
      .stats-table th,
      .stats-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .stats-table th {
        background-color: #f0f0f0;
      }
      .alert {
        background: #fff;
        border-left: 5px solid red;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .alert h3 {
        margin: 0 0 0.5rem 0;
      }
      .low {
        border-color: #ccc;
      }
      .medium {
        border-color: orange;
      }
      .high {
        border-color: red;
      }
      #content {
        width: 100%;
        max-width: 1000px;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <h1>ðŸš¨ Severe Weather Score</h1>
      <canvas id="scoreChart" width="600" height="200"></canvas>
      <h3>
        Max Score (Last Hour): <span id="maxScoreLastHour">Loading...</span>
      </h3>

      <div class="score-box">
        <h2>Current Score: <span id="score">Loading...</span></h2>
      </div>

      <!-- ðŸ“Š Stats Table -->
      <table class="stats-table">
        <thead>
          <tr>
            <th>Tornado Emergencies</th>
            <th>PDS Warnings</th>
            <th>Tornado Warnings</th>
            <th>Severe T-Storm Warnings</th>
            <th>Total Warnings</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="torECount">0</td>
            <td id="pdsCount">0</td>
            <td id="tornadoCount">0</td>
            <td id="svrCount">0</td>
            <td id="totalCount">0</td>
          </tr>
        </tbody>
      </table>

      <div id="statsDisplay" class="stats-container"></div>
      <div id="alerts"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      function getWeight(type) {
        const t = type?.toLowerCase();
        if (t === "tornado emergency") {
            //do this to all of them but before you do, you need to either take the value in the html or create some var that keeps track of the val and update that and then at the end set the values => hopefully that makes sense kai lol
            //unrelated but lets change the background color based on the score OR the most severe event at the time
            // $("#torECount")
            return 300
        };
        if (t.includes("particularly dangerous")) return 150;
        if (t === "tornado warning") return 50;
        if (t === "tornado watch") return 20;
        if (t === "severe thunderstorm warning") return 10;
        return 0;
      }

      function getSeverityClass(weight) {
        if (weight >= 150) return "high";
        if (weight >= 50) return "medium";
        return "low";
      }

      function renderAlerts(alerts) {
        const $container = $("#alerts").empty();

        alerts.sort(
          (a, b) =>
            getWeight(b.properties.event) - getWeight(a.properties.event)
        );

        alerts.forEach((alert) => {
          if (alert.properties.event == "Severe Thunderstorm Warning") return;
          const severity = getWeight(alert.properties.event);
          const $alert = $(`
          <div class="alert ${getSeverityClass(severity)}">
            <h3>${alert.properties.event}</h3>
            <p><strong>Area:</strong> ${alert.properties.areaDesc}</p>
            <p><strong>Severity:</strong> ${alert.properties.severity}</p>
            <p><strong>Certainty:</strong> ${alert.properties.certainty}</p>
            <p><strong>Sent:</strong> ${new Date(
              alert.properties.sent
            ).toLocaleString()}</p>
            <p>${alert.properties.headline || "No headline provided."}</p>
          </div>
        `);
          $container.append($alert);
        });
      }

      function fetchScore() {
        console.log("Fetching score...");

        fetch("http://localhost:3000/weather-score")
          .then((res) => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
          })
          .then((data) => {
            $("#score").text(data.score);
            renderAlerts(data.alerts);
            renderChart(data.history);
            document.getElementById("maxScoreLastHour").textContent =
              data.maxLastHour;
            console.log("Data received:", data);
          })
          .catch((error) => {
            console.error("Error fetching score:", error);
            $("#score").text("Error fetching data.");
          });
      }

      let chart;

      function renderChart(history) {
        const labels = history.map((entry) =>
          new Date(entry.timestamp).toLocaleTimeString()
        );
        const scores = history.map((entry) => entry.score);

        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = scores;
          chart.update();
        } else {
          chart = new Chart(document.getElementById("scoreChart"), {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Score",
                  data: scores,
                  borderColor: "red",
                  fill: false,
                },
              ],
            },
            options: {
              scales: {
                x: { display: true },
                y: { beginAtZero: true },
              },
            },
          });
        }
      }

      $(document).ready(function () {
        fetchScore();
        setInterval(fetchScore, 60000); // every minute
      });
    </script>
  </body>
</html>
